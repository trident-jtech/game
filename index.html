<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D Shooter PWA</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/00ffff/000000?text=3D">

    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: sans-serif; touch-action: none; }
        #crosshair {
            position: absolute; top: 50%; left: 50%;
            width: 24px; height: 24px; border: 2px solid #00ffff;
            border-radius: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 999;
        }
        #ui {
            position: absolute; top: 40px; left: 20px; color: #00ffff;
            font-size: 20px; font-weight: bold; pointer-events: none; z-index: 10;
        }
        #explosion-overlay, #clear-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; z-index: 100;
        }
        #explosion-overlay {
            background: radial-gradient(circle at center, #fff 0%, #ffec00 10%, #ff5e00 30%, #ff0000 50%, #220000 80%, #000 100%);
        }
        .explode-ani {
            display: block !important;
            animation: boom-zoom 0.6s forwards, shake 0.08s infinite, burn-pulse 0.4s infinite alternate;
        }
        #clear-overlay {
            background-image: url('https://r.jina.ai/i/6561f008-8e6f-40ed-84d9-d08316c024d2');
            background-size: cover; background-position: center; background-color: #0088ff;
            opacity: 0; animation: clear-fade-in 2s forwards;
        }
        #flash { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: none; z-index: 1000; }
        .retry-ui {
            position: absolute; top: 75%; left: 50%; transform: translateX(-50%);
            z-index: 1001; display: none; text-align: center; opacity: 0; transition: opacity 1s;
        }
        button { font-size: 22px; padding: 15px 40px; cursor: pointer; background: #ff3300; color: white; border: none; font-weight: bold; border-radius: 50px; }
        .miss-box { display: inline-block; width: 20px; height: 20px; border: 2px solid #00ffff; margin-left: 5px; }
        .missed { background: #ff3300; border-color: #ff3300; }
        @keyframes clear-fade-in { from { opacity: 0; } to { opacity: 1; } }
        @keyframes boom-zoom { 0% { transform: scale(0.3); } 100% { transform: scale(1.3); } }
        @keyframes shake { 0% { transform: translate(-5px,-5px); } 50% { transform: translate(5px,5px); } }
        @keyframes burn-pulse { from { filter: brightness(1); } to { filter: brightness(1.5); } }
    </style>
</head>
<body>
    <div id="flash"></div>
    <div id="crosshair"></div>
    <div id="ui">TGTS: <span id="count">0</span><br>LIFE: <span id="m1" class="miss-box"></span><span id="m2" class="miss-box"></span><span id="m3" class="miss-box"></span></div>
    <div id="explosion-overlay"></div>
    <div id="clear-overlay"></div>
    <div id="retry-ui" class="retry-ui"><button onclick="location.reload()">RETRY</button></div>
    <div id="clear-retry-ui" class="retry-ui"><button onclick="location.reload()">RETRY</button></div>

    <script type="importmap">{ "imports": { "three": "https://unpkg.com/three@0.160.0/build/three.module.js" } }</script>
    <script type="module">
        import * as THREE from 'three';
        // サービスワーカーの登録
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }

        let isFinished = false;
        let missCount = 0;
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // 音響関数
        const playSnd = (type, fStart, fEnd, vol, dur) => {
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.type = type;
            o.frequency.setValueAtTime(fStart, audioCtx.currentTime);
            if(fEnd) o.frequency.exponentialRampToValueAtTime(fEnd, audioCtx.currentTime + dur);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
            o.connect(g); g.connect(audioCtx.destination);
            o.start(); o.stop(audioCtx.currentTime + dur);
        };

        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000510);
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        scene.add(new THREE.GridHelper(100, 40, 0x00ffff, 0x002222));

        const targets = [];
        for(let x = -2; x <= 2; x++) {
            for(let y = 0; y <= 1; y++) {
                const t = new THREE.Mesh(new THREE.BoxGeometry(3, 3, 3), new THREE.MeshPhongMaterial({ color: 0x00ffff }));
                t.position.set(x * 8, y * 6 + 2, -30);
                t.userData = { offset: Math.random() * 10 };
                targets.push(t); scene.add(t);
            }
        }
        document.getElementById('count').innerText = targets.length;

        const bullets = [];
        const shoot = () => {
            if(isFinished) return;
            if(audioCtx.state === 'suspended') audioCtx.resume();
            playSnd('triangle', 800, 100, 0.2, 0.1);
            const b = new THREE.Mesh(new THREE.SphereGeometry(0.5), new THREE.MeshBasicMaterial({color: 0xffffff}));
            b.position.copy(camera.position);
            const dir = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            b.velocity = dir.multiplyScalar(1.5);
            scene.add(b); bullets.push(b);
        };

        // タッチ視点移動
        let lat = 0, lon = 0, pX = 0, pY = 0;
        const move = (x, y) => {
            if(isFinished) return;
            if(pX !== 0) {
                lon += (pX - x) * 0.2;
                lat += (y - pY) * 0.2;
                lat = Math.max(-85, Math.min(85, lat));
            }
            pX = x; pY = y;
        };
        window.addEventListener('touchmove', e => move(e.touches[0].clientX, e.touches[0].clientY), {passive:false});
        window.addEventListener('mousemove', e => move(e.clientX, e.clientY));
        window.addEventListener('touchend', () => { pX = 0; shoot(); });
        window.addEventListener('mousedown', shoot);

        function trigger(type) {
            isFinished = true;
            if(type === 'boom') {
                playSnd('sawtooth', 200, 10, 1, 3);
                document.getElementById('flash').style.display = 'block';
                setTimeout(()=>document.getElementById('flash').style.display='none', 80);
                document.getElementById('explosion-overlay').classList.add('explode-ani');
                const ui = document.getElementById('retry-ui');
                ui.style.display = 'block'; setTimeout(()=>ui.style.opacity="1", 2000);
            } else {
                [523, 659, 784, 1046].forEach((f, i) => setTimeout(()=>playSnd('sine', f, 0, 0.2, 0.5), i*150));
                document.getElementById('clear-overlay').style.display = 'block';
                const ui = document.getElementById('clear-retry-ui');
                ui.style.display = 'block'; setTimeout(()=>ui.style.opacity="1", 2000);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(isFinished) return;
            const phi = THREE.MathUtils.degToRad(90 - lat);
            const theta = THREE.MathUtils.degToRad(lon);
            camera.lookAt(camera.position.clone().add(new THREE.Vector3().setFromSphericalCoords(1, phi, theta)));
            targets.forEach(t => t.position.x += Math.sin(Date.now()*0.002+t.userData.offset)*0.05);
            for(let i = bullets.length - 1; i >= 0; i--) {
                const b = bullets[i]; b.position.add(b.velocity);
                let hit = false;
                for(let j = targets.length - 1; j >= 0; j--) {
                    const t = targets[j];
                    if(b.position.distanceTo(t.position) < 4.0) {
                        scene.remove(t); targets.splice(j, 1);
                        scene.remove(b); bullets.splice(i, 1);
                        hit = true;
                        document.getElementById('count').innerText = targets.length;
                        if(targets.length === 0) trigger('clear');
                        break;
                    }
                }
                if(!hit && b.position.z < -60) {
                    scene.remove(b); bullets.splice(i, 1);
                    missCount++;
                    if(missCount <= 3) document.getElementById('m' + missCount).classList.add('missed');
                    if(missCount >= 3) trigger('boom');
                }
            }
            renderer.render(scene, camera);
        }
        animate();
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
